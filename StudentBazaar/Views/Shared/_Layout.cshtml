@using StudentBazaar.Web.Models
@inject Microsoft.AspNetCore.Identity.UserManager<ApplicationUser> UserManager

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - StudentBazaar</title>

    <link href="~/css/bootstrap.min (3).css" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/buttons.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/StudentBazaar.styles.css" asp-append-version="true" />
</head>
<body>
    @{
        // --------- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿπŸÜ ÿßŸÑŸäŸàÿ≤ÿ± ÿßŸÑÿ≠ÿßŸÑŸä ----------
        bool isAuthenticated = User.Identity?.IsAuthenticated ?? false;
        ApplicationUser? currentUser = null;
        bool isAdmin = false;

        if (isAuthenticated)
        {
            currentUser = await UserManager.GetUserAsync(User);
            if (currentUser != null)
            {
                isAdmin = await UserManager.IsInRoleAsync(currentUser, "Admin");
            }
        }

        string currentController = ViewContext.RouteData.Values["controller"]?.ToString() ?? "";
        string currentAction = ViewContext.RouteData.Values["action"]?.ToString() ?? "";
        string currentArea = ViewContext.RouteData.Values["area"]?.ToString() ?? "";

        // üëá ÿßÿ≥ŸÖ Ÿäÿ™ÿπÿ±ÿ∂ ŸÅŸä ÿßŸÑŸÄNavbar (ŸÖŸÖŸÉŸÜ ŸÜÿ∫ŸäŸëÿ±Ÿá ŸÖŸÜ ÿ£Ÿä View ÿπŸÜ ÿ∑ÿ±ŸäŸÇ ViewData["NavDisplayName"])
        string? overrideName = ViewData["NavDisplayName"] as string;
        string displayName = overrideName ?? (currentUser?.FullName ?? User.Identity?.Name ?? "User");
    }
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom box-shadow mb-3">
            <div class="container-fluid">

                <!-- Logo -->
                <a class="navbar-brand fw-bold" asp-area="" asp-controller="Product" asp-action="Index">
                    StudentBazaar
                </a>

                <!-- Search Box -->
                <form class="d-none d-md-flex ms-3 flex-grow-1" asp-controller="Product" asp-action="Index" method="get">
                    <input type="text" name="q" class="form-control" placeholder="Search products..." />
                </form>

                <!-- Toggle -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
                    <span class="navbar-toggler-icon"></span>
                </button>


                <div class="collapse navbar-collapse" id="mainNavbar">

                    <!-- LEFT LINKS -->
                    <ul class="navbar-nav me-auto">

                        @if (isAuthenticated)
                        {
                            <li class="nav-item">
                                <a class="nav-link text-dark @(currentController == "Product" && currentAction == "MyProducts" ? "active fw-bold" : "")"
                                   asp-controller="Product" asp-action="MyProducts">Products for Sale</a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link text-dark @(currentController == "Product" && currentAction == "Index" ? "active fw-bold" : "")"
                                   asp-controller="Product" asp-action="Index">Products for Buy</a>
                            </li>
                        }
                        else
                        {
                           @*  <li class="nav-item">
                                <a class="nav-link text-dark @(currentController == "Product" && currentAction == "Index" ? "active fw-bold" : "")"
                                   asp-controller="Product" asp-action="Index">Shop</a>
                            </li> *@
                        }

                       @*  <li class="nav-item">
                            <a class="nav-link text-dark @(currentController == "Home" && currentAction == "Index" ? "active fw-bold" : "")"
asp-controller="Home" asp-action="Index">Home</a>
                        </li> *@

                        <!-- Mega Menu -->
                       @*  <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-dark" data-bs-toggle="dropdown">Categories</a>
                            <ul class="dropdown-menu p-3" style="width: 350px;">
                                <li><a class="dropdown-item" asp-controller="Product" asp-action="ByCategory" asp-route-id="1">Electronics</a></li>
                                <li><a class="dropdown-item" asp-controller="Product" asp-action="ByCategory" asp-route-id="2">Books</a></li>
                                <li><a class="dropdown-item" asp-controller="Product" asp-action="ByCategory" asp-route-id="3">Clothes</a></li>
                                <li><a class="dropdown-item" asp-controller="Product" asp-action="ByCategory" asp-route-id="4">Furniture</a></li>
                            </ul>
                        </li> *@

                    </ul>


                    <!-- RIGHT SIDE -->
                    <ul class="navbar-nav align-items-center">

                        @if (isAuthenticated)
                        {
                           @*  <!-- Notifications -->
                            <li class="nav-item dropdown me-3">
                                <a class="nav-link position-relative" data-bs-toggle="dropdown">
                                    üîî
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">3</span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end p-2" style="width:300px;">
                                    <li><strong class="dropdown-header">Notifications</strong></li>
                                    <li><hr /></li>
                                    <li><a class="dropdown-item">Your order has been shipped ‚úî</a></li>
                                    <li><a class="dropdown-item">New message received üí¨</a></li>
                                    <li><a class="dropdown-item">Price dropped for item you liked üîΩ</a></li>
                                </ul>
                            </li> *@

                           @*  <!-- Wishlist -->
                            <li class="nav-item me-3">
                                <a class="nav-link @(currentController == "Wishlist" ? "active fw-bold" : "")"
                                   asp-controller="Wishlist" asp-action="Index">‚ù§Ô∏è Wishlist</a>
                            </li> *@

                            <!-- Orders -->
                            <li class="nav-item me-3">
                                <a class="nav-link @(currentController == "Order" ? "active fw-bold" : "")"
                                   asp-controller="Order" asp-action="Index">üì¶ Orders</a>
                            </li> 

                            <!-- Cart -->
                            <li class="nav-item me-3">
                                <a class="nav-link @(currentController == "Cart" ? "active fw-bold" : "")"
                                   asp-controller="Cart" asp-action="Index">
                                    üõí Cart
                                </a>
                            </li>

                            <!-- Messages -->
                            <li class="nav-item me-3">
                                <a class="nav-link position-relative @(currentController == "Chat" ? "active fw-bold" : "")"
                                   asp-controller="Chat" asp-action="Open">
                                    üí¨ Messages
                                    <span id="msgBadge" class="badge-notification">0</span>
                                </a>
                            </li>

                            <!-- Dashboard -->
                            @if (isAdmin)
                            {
                                <!-- Dashboard Link -->
                                <li class="nav-item me-3">
                                    <a class="nav-link @(currentController == "Dashboard" && currentArea == "Admin" ? "active fw-bold" : "") text-danger fw-bold"
                                       asp-area="Admin" asp-controller="Dashboard" asp-action="Index">
                                        üìä Dashboard
                                    </a>
                                </li>
                                
                                <!-- Notifications Dropdown -->
                                <li class="nav-item dropdown me-3" id="notificationsDropdownContainer" style="display: none;">
                                    <a class="nav-link position-relative" data-bs-toggle="dropdown" id="notificationsDropdown" role="button" aria-expanded="false">
                                        üîî
                                        <span id="notificationsBadge" class="badge-notification" style="display: none;">0</span>
                                    </a>
                                    <ul class="dropdown-menu dropdown-menu-end" id="dashboardNotificationsList" style="width: 350px; max-height: 400px; overflow-y: auto;">
                                        <li><h6 class="dropdown-header">Notifications</h6></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li id="notificationsLoading" class="px-3 py-2 text-muted">
                                            <small>Loading notifications...</small>
                                        </li>
                                        <li id="notificationsEmpty" class="px-3 py-2 text-muted" style="display: none;">
                                            <small>No notifications</small>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-center text-primary" asp-area="Admin" asp-controller="Dashboard" asp-action="Index">
                                                <strong>View All ‚Üí</strong>
                                            </a>
                                        </li>
                                    </ul>
                                </li>
                            }

                            <!-- Profile -->
                            <li class="nav-item dropdown me-3">
                                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                                    üë§ @displayName
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" asp-controller="Account" asp-action="Profile">üìù My Profile</a></li>
                                   @*  <li><a class="dropdown-item" asp-controller="Account" asp-action="Settings">‚öôÔ∏è Settings</a></li> *@
                                </ul>
                            </li>

                            <!-- Logout -->
                            <li class="nav-item">
                                <form asp-controller="Account" asp-action="Logout" method="post">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-danger">Logout</button>
                                </form>
                            </li>
                        }
                        else
                        {
                            <!-- Guest -->
                            <li class="nav-item me-2">
                                <a class="btn btn-outline-primary" asp-controller="Account" asp-action="Login">Login</a>
                            </li>
                            <li class="nav-item">
                                <a class="btn btn-primary" asp-controller="Account" asp-action="Register">Register</a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
    </header>

 @*    <header>
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3">
            <div class="container-fluid">

                <!-- ŸÑŸàÿ¨Ÿà / ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàŸÇÿπ ŸäŸàÿØŸëŸä ÿπŸÑŸâ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
                <a class="navbar-brand fw-bold" asp-area="" asp-controller="Product" asp-action="Index">
                    StudentBazaar
                </a>

                <button class="navbar-toggler" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target=".navbar-collapse"
                        aria-controls="navbarSupportedContent"
                        aria-expanded="false"
                        aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">

                    <!-- LEFT LINKS -->
                    <ul class="navbar-nav flex-grow-1">
                        <li class="nav-item">
                            <a class="nav-link text-dark @(currentController == "Product" ? "active fw-semibold" : "")"
                               asp-controller="Product" asp-action="Index">
                                Shop
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark @(currentController == "Home" && currentAction == "Index" ? "active fw-semibold" : "")"
                               asp-controller="Home" asp-action="Index">
                                Home
                            </a>
                        </li>
                    </ul>

                    <!-- RIGHT SIDE -->
                    <ul class="navbar-nav align-items-center">

                        @if (isAuthenticated)
                        {
                            <!-- ÿßÿ≥ŸÖ ÿßŸÑŸäŸàÿ≤ÿ± ÿ£Ÿà ÿßÿ≥ŸÖ ÿßŸÑŸÑŸä ÿ®ŸÉŸÑŸÖŸá ŸÅŸä ÿßŸÑÿ¥ÿßÿ™ -->
                            <li class="nav-item me-3">
                                <span class="navbar-text">
                                    Hello, @displayName
                                    @if (isAdmin)
                                    {
                                        <span class="badge bg-danger ms-1">Admin</span>
                                    }
                                </span>
                            </li>

                            <!-- Cart -->
                            <li class="nav-item me-3">
                                <a class="nav-link position-relative @(currentController == "Cart" ? "active" : "")"
                                   asp-controller="Cart" asp-action="Index">
                                    üõí Cart
                                </a>
                            </li>

                            <!-- Messages -->
                            <li class="nav-item me-3">
                                <a class="nav-link @(currentController == "Chat" ? "active fw-semibold" : "")"
                                   asp-controller="Chat" asp-action="Open">
                                    Messages
                                </a>
                            </li>

                            <!-- Logout -->
                            <li class="nav-item">
                                <form asp-controller="Account" asp-action="Logout" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-danger">
                                        Logout
                                    </button>
                                </form>
                            </li>
                        }
                        else
                        {
                            <!-- Login / Register -->
                            <li class="nav-item me-2">
                                <a class="btn btn-outline-primary"
                                   asp-controller="Account"
                                   asp-action="Login">
                                    Login
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="btn btn-primary"
                                   asp-controller="Account"
                                   asp-action="Register">
                                    Register
                                </a>
                            </li>
                        }

                    </ul>

                </div>
            </div>
        </nav>
    </header> *@

    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <footer class="border-top footer text-muted">
        <div class="container">
            &copy; 2025 - StudentBazaar -
            <a asp-controller="Home" asp-action="Privacy">Privacy</a>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    
    @if (isAuthenticated)
    {
        <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
        <script>
            // Set current user ID for notifications.js
            window.currentUserId = '@(currentUser != null ? currentUser.Id.ToString() : "")';
            window.isAdmin = @(isAdmin ? "true" : "false");
        </script>
        <script src="~/js/notifications.js" asp-append-version="true"></script>
        @if (isAdmin)
        {
            <script>
                // Dashboard Notifications for Admin
                (function() {
                    let adminHubConnection = null;
                    const notificationsBadge = document.getElementById('notificationsBadge');
                    const notificationsContainer = document.getElementById('notificationsDropdownContainer');
                    
                    if (!notificationsBadge || !notificationsContainer) return;
                    
                    // Hide badge and container initially
                    notificationsBadge.style.display = 'none';
                    notificationsContainer.style.display = 'none';
                    
                    // Function to update notifications badge
                    async function updateNotificationsBadge() {
                        try {
                            const response = await fetch('/Admin/Notifications/GetDashboardNotificationsCount');
                            if (response.ok) {
                                const data = await response.json();
                                const count = data.count || 0;
                                
                                if (notificationsBadge && notificationsContainer) {
                                    if (count > 0) {
                                        notificationsBadge.textContent = count > 99 ? '99+' : count;
                                        notificationsBadge.classList.add('show');
                                        notificationsContainer.style.display = 'block';
                                        
                                        // Update browser tab title if there are notifications
                                        document.title = `(${count}) Dashboard - StudentBazaar`;
                                    } else {
                                        notificationsBadge.classList.remove('show');
                                        notificationsContainer.style.display = 'none';
                                        document.title = 'Dashboard - StudentBazaar';
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Error updating notifications badge:', error);
                        }
                    }
                    
                    // Function to load notifications in dropdown
                    async function loadNotifications() {
                        const notificationsList = document.getElementById('dashboardNotificationsList');
                        const loadingEl = document.getElementById('notificationsLoading');
                        const emptyEl = document.getElementById('notificationsEmpty');
                        
                        if (!notificationsList) return;
                        
                        try {
                            const response = await fetch('/Admin/Notifications/GetNotifications');
                            if (response.ok) {
                                const notifications = await response.json();
                                
                                // Remove loading and empty messages
                                if (loadingEl) loadingEl.style.display = 'none';
                                if (emptyEl) emptyEl.style.display = 'none';
                                
                                // Clear existing notifications (except header and divider)
                                const itemsToRemove = notificationsList.querySelectorAll('li:not(.dropdown-header):not(.dropdown-divider):not(#notificationsLoading):not(#notificationsEmpty)');
                                itemsToRemove.forEach(item => item.remove());
                                
                                if (notifications && notifications.length > 0) {
                                    notifications.forEach(function(notif) {
                                        const iconClass = notif.type?.toLowerCase() === 'success' ? '‚úÖ' : 
                                                         notif.type?.toLowerCase() === 'warning' ? '‚ö†Ô∏è' : 
                                                         notif.type?.toLowerCase() === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
                                        
                                        const itemClass = notif.isRead ? '' : 'fw-bold bg-light';
                                        
                                        const date = new Date(notif.createdAt);
                                        const timeAgo = getTimeAgo(date);
                                        
                                        const li = document.createElement('li');
                                        li.className = itemClass;
                                        
                                        let html = `<a class="dropdown-item ${notif.linkUrl ? '' : 'pe-none'}" ${notif.linkUrl ? `href="${notif.linkUrl}"` : ''}>`;
                                        html += `<div class="d-flex align-items-center">`;
                                        html += `<span class="me-2">${iconClass}</span>`;
                                        html += `<div class="flex-grow-1">`;
                                        html += `<strong class="small">${escapeHtml(notif.title)}</strong>`;
                                        html += `<small class="text-muted d-block mt-1">${timeAgo}</small>`;
                                        html += `</div>`;
                                        html += `</div>`;
                                        html += `</a>`;
                                        
                                        li.innerHTML = html;
                                        notificationsList.appendChild(li);
                                    });
                                } else {
                                    if (emptyEl) emptyEl.style.display = 'block';
                                }
                            }
                        } catch (error) {
                            console.error('Error loading notifications:', error);
                            if (loadingEl) loadingEl.innerHTML = '<small class="text-danger">Error loading notifications</small>';
                        }
                    }
                    
                    // Helper function to get time ago
                    function getTimeAgo(date) {
                        const now = new Date();
                        const diff = now - date;
                        const seconds = Math.floor(diff / 1000);
                        const minutes = Math.floor(seconds / 60);
                        const hours = Math.floor(minutes / 60);
                        const days = Math.floor(hours / 24);
                        
                        if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
                        if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
                        if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                        return 'Just now';
                    }
                    
                    // Helper function to escape HTML
                    function escapeHtml(text) {
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    }
                    
                    // Setup SignalR connection for admin notifications
                    function setupAdminHub() {
                        if (typeof signalR === 'undefined') {
                            console.warn('SignalR not available for admin notifications');
                            // Fallback to polling
                            setInterval(updateNotificationsBadge, 5000);
                            return;
                        }
                        
                        try {
                            adminHubConnection = new signalR.HubConnectionBuilder()
                                .withUrl("/adminhub")
                                .withAutomaticReconnect()
                                .build();
                            
                            // Listen for admin notifications
                            adminHubConnection.on("AdminNotification", function(data) {
                                updateNotificationsBadge();
                            });
                            
                            adminHubConnection.on("NewProduct", function(productId) {
                                updateNotificationsBadge();
                            });
                            
                            adminHubConnection.on("NewReport", function(reportId) {
                                updateNotificationsBadge();
                            });
                            
                            adminHubConnection.on("NewVerification", function(verificationId) {
                                updateNotificationsBadge();
                            });
                            
                            adminHubConnection.on("SuspiciousActivity", function(message) {
                                updateNotificationsBadge();
                            });
                            
                            adminHubConnection.on("NewOrder", function(orderId) {
                                updateNotificationsBadge();
                                // Reload notifications if dropdown is open
                                const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('notificationsDropdown'));
                                if (dropdown && dropdown._isShown()) {
                                    loadNotifications();
                                }
                            });
                            
                            adminHubConnection.on("ProductApproved", function(productId) {
                                updateNotificationsBadge();
                                // Reload notifications if dropdown is open
                                const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('notificationsDropdown'));
                                if (dropdown && dropdown._isShown()) {
                                    loadNotifications();
                                }
                            });
                            
                            // Start connection
                            adminHubConnection.start()
                                .then(function() {
                                    console.log('Admin Hub connected');
                                    // Join admin group
                                    adminHubConnection.invoke("JoinAdminGroup");
                                    // Initial update
                                    updateNotificationsBadge();
                                })
                                .catch(function(error) {
                                    console.warn('Admin Hub connection failed, using polling:', error);
                                    // Fallback to polling
                                    setInterval(updateNotificationsBadge, 5000);
                                });
                            
                            // Handle reconnection
                            adminHubConnection.onreconnecting(function() {
                                console.log('Admin Hub reconnecting...');
                            });
                            
                            adminHubConnection.onreconnected(function() {
                                console.log('Admin Hub reconnected');
                                adminHubConnection.invoke("JoinAdminGroup");
                                updateNotificationsBadge();
                            });
                            
                        } catch (error) {
                            console.error('Error setting up Admin Hub:', error);
                            // Fallback to polling
                            setInterval(updateNotificationsBadge, 5000);
                        }
                    }
                    
                    // Load notifications when dropdown is opened
                    const notificationsDropdown = document.getElementById('notificationsDropdown');
                    if (notificationsDropdown) {
                        notificationsDropdown.addEventListener('shown.bs.dropdown', function() {
                            loadNotifications();
                        });
                    }
                    
                    // Initialize
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', function() {
                            // Initial update
                            updateNotificationsBadge();
                            setupAdminHub();
                            // Also use polling as backup
                            setInterval(updateNotificationsBadge, 10000);
                        });
                    } else {
                        // Initial update
                        updateNotificationsBadge();
                        setupAdminHub();
                        // Also use polling as backup
                        setInterval(updateNotificationsBadge, 10000);
                    }
                })();
            </script>
        }
    }

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
