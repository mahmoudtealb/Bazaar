@using StudentBazaar.Web.Models
@inject Microsoft.AspNetCore.Identity.UserManager<ApplicationUser> UserManager

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - StudentBazaar</title>

    <link href="~/css/bootstrap.min (3).css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/buttons.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/ui-enhancements.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/professional-ui.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/StudentBazaar.styles.css" asp-append-version="true" />
</head>
<body>
    @{
        // --------- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿπŸÜ ÿßŸÑŸäŸàÿ≤ÿ± ÿßŸÑÿ≠ÿßŸÑŸä ----------
        bool isAuthenticated = User.Identity?.IsAuthenticated ?? false;
        ApplicationUser? currentUser = null;
        bool isAdmin = false;

        if (isAuthenticated)
        {
            currentUser = await UserManager.GetUserAsync(User);
            if (currentUser != null)
            {
                isAdmin = await UserManager.IsInRoleAsync(currentUser, "Admin");
            }
        }

        string currentController = ViewContext.RouteData.Values["controller"]?.ToString() ?? "";
        string currentAction = ViewContext.RouteData.Values["action"]?.ToString() ?? "";
        string currentArea = ViewContext.RouteData.Values["area"]?.ToString() ?? "";

        // üëá ÿßÿ≥ŸÖ Ÿäÿ™ÿπÿ±ÿ∂ ŸÅŸä ÿßŸÑŸÄNavbar (ŸÖŸÖŸÉŸÜ ŸÜÿ∫ŸäŸëÿ±Ÿá ŸÖŸÜ ÿ£Ÿä View ÿπŸÜ ÿ∑ÿ±ŸäŸÇ ViewData["NavDisplayName"])
        string? overrideName = ViewData["NavDisplayName"] as string;
        string displayName = overrideName ?? (currentUser?.FullName ?? User.Identity?.Name ?? "User");
    }
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom box-shadow mb-3 modern-navbar">
            <div class="container-fluid">

                <!-- Logo -->
                <a class="navbar-brand fw-bold brand-logo" asp-area="" asp-controller="Product" asp-action="Index">
                    <span class="brand-text">StudentBazaar</span>
                </a>

                <!-- Search Box -->
                <form class="d-none d-md-flex flex-grow-1 modern-search" asp-controller="Product" asp-action="Index" method="get">
                    <div class="search-wrapper">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" name="q" class="form-control modern-search-input" placeholder="   Search products..." />
                    </div>
                </form>

                <!-- Toggle -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
                    <span class="navbar-toggler-icon"></span>
                </button>


                <div class="collapse navbar-collapse" id="mainNavbar">

                    <!-- LEFT LINKS -->
                    <ul class="navbar-nav me-auto">

                        @if (isAuthenticated)
                        {
                            <li class="nav-item">
                                <a class="nav-link text-dark @(currentController == "Product" && currentAction == "MyProducts" ? "active fw-bold" : "")"
                                   asp-controller="Product" asp-action="MyProducts">
                                    <i class="bi bi-shop me-1"></i> Products for Sale
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link text-dark @(currentController == "Product" && currentAction == "Index" ? "active fw-bold" : "")"
                                   asp-controller="Product" asp-action="Index">
                                    <i class="bi bi-bag-check me-1"></i> Products for Buy
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link text-dark @(currentController == "Product" && currentAction == "ForRent" ? "active fw-bold" : "")"
                                   asp-controller="Product" asp-action="ForRent">
                                    <i class="bi bi-calendar-check me-1"></i> Products for Rent
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link text-success fw-bold @(currentController == "Product" && currentAction == "Create" ? "active" : "")"
                                   asp-controller="Product" asp-action="Create">
                                    <i class="bi bi-plus-circle me-1"></i> Add Product
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link text-info fw-bold @(currentController == "Product" && currentAction == "CreateRental" ? "active" : "")"
                                   asp-controller="Product" asp-action="CreateRental">
                                    <i class="bi bi-calendar-check me-1"></i> Rent Items
                                </a>
                            </li>
                        }
                        else
                        {
                            <!-- Show Products for Buy and Rent for anonymous users -->
                            <li class="nav-item">
                                <a class="nav-link text-dark @(currentController == "Product" && currentAction == "Index" ? "active fw-bold" : "")"
                                   asp-controller="Product" asp-action="Index">
                                    <i class="bi bi-bag-check me-1"></i> Products for Buy
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link text-dark @(currentController == "Product" && currentAction == "ForRent" ? "active fw-bold" : "")"
                                   asp-controller="Product" asp-action="ForRent">
                                    <i class="bi bi-calendar-check me-1"></i> Products for Rent
                                </a>
                            </li>
                        }

                       @*  <li class="nav-item">
                            <a class="nav-link text-dark @(currentController == "Home" && currentAction == "Index" ? "active fw-bold" : "")"
asp-controller="Home" asp-action="Index">Home</a>
                        </li> *@

                        <!-- Mega Menu -->
                       @*  <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-dark" data-bs-toggle="dropdown">Categories</a>
                            <ul class="dropdown-menu p-3" style="width: 350px;">
                                <li><a class="dropdown-item" asp-controller="Product" asp-action="ByCategory" asp-route-id="1">Electronics</a></li>
                                <li><a class="dropdown-item" asp-controller="Product" asp-action="ByCategory" asp-route-id="2">Books</a></li>
                                <li><a class="dropdown-item" asp-controller="Product" asp-action="ByCategory" asp-route-id="3">Clothes</a></li>
                                <li><a class="dropdown-item" asp-controller="Product" asp-action="ByCategory" asp-route-id="4">Furniture</a></li>
                            </ul>
                        </li> *@

                    </ul>


                    <!-- RIGHT SIDE -->
                    <ul class="navbar-nav align-items-center">

                        @if (isAuthenticated)
                        {
                           @*  <!-- Notifications -->
                            <li class="nav-item dropdown me-3">
                                <a class="nav-link position-relative" data-bs-toggle="dropdown">
                                    üîî
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">3</span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end p-2" style="width:300px;">
                                    <li><strong class="dropdown-header">Notifications</strong></li>
                                    <li><hr /></li>
                                    <li><a class="dropdown-item">Your order has been shipped ‚úî</a></li>
                                    <li><a class="dropdown-item">New message received üí¨</a></li>
                                    <li><a class="dropdown-item">Price dropped for item you liked üîΩ</a></li>
                                </ul>
                            </li> *@

                           @*  <!-- Wishlist -->
                            <li class="nav-item me-3">
                                <a class="nav-link @(currentController == "Wishlist" ? "active fw-bold" : "")"
                                   asp-controller="Wishlist" asp-action="Index">‚ù§Ô∏è Wishlist</a>
                            </li> *@

                            <!-- Orders -->
                            <li class="nav-item me-3">
                                <a class="nav-link @(currentController == "Order" ? "active fw-bold" : "")"
                                   asp-controller="Order" asp-action="Index">
                                    <i class="bi bi-box-seam me-1"></i> Orders
                                </a>
                            </li> 

                            <!-- Cart -->
                            <li class="nav-item me-3">
                                <a class="nav-link @(currentController == "Cart" ? "active fw-bold" : "")"
                                   asp-controller="Cart" asp-action="Index">
                                    <i class="bi bi-cart3 me-1"></i> Cart
                                </a>
                            </li>

                            <!-- Messages -->
                            <li class="nav-item me-3">
                                <a class="nav-link position-relative @(currentController == "Chat" ? "active fw-bold" : "")"
                                   asp-controller="Chat" asp-action="Open">
                                    <i class="bi bi-chat-dots me-1"></i> Messages
                                    <span id="msgBadge" class="badge-notification">0</span>
                                </a>
                            </li>

                            <!-- Dashboard -->
                            @if (isAdmin)
                            {
                                <!-- Notifications Dropdown -->
                                <li class="nav-item dropdown me-3" id="notificationsDropdownContainer" style="position: relative; z-index: 1050;">
                                    <a class="nav-link position-relative" data-bs-toggle="dropdown" id="notificationsDropdown" role="button" aria-expanded="false">
                                        <i class="bi bi-bell"></i>
                                        <span id="notificationsBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none; font-size: 0.65rem; z-index: 1051;">0</span>
                                    </a>
                                    <ul class="dropdown-menu dropdown-menu-end" id="dashboardNotificationsList" style="width: 350px; max-height: 400px; overflow-y: auto; z-index: 1051 !important; position: absolute !important;">
                                        <li><h6 class="dropdown-header">Notifications</h6></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li id="notificationsLoading" class="px-3 py-2 text-muted">
                                            <small>Loading notifications...</small>
                                        </li>
                                        <li id="notificationsEmpty" class="px-3 py-2 text-muted" style="display: none;">
                                            <small>No notifications</small>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <button type="button" class="dropdown-item text-center" id="markAllAsReadBtn" style="border: none; background: none; width: 100%; cursor: pointer;">
                                                <small class="text-primary"><strong>Mark All as Read</strong></small>
                                            </button>
                                        </li>
                                        <li>
                                            <a class="dropdown-item text-center" asp-area="Admin" asp-controller="Dashboard" asp-action="Index">
                                                <small class="text-primary"><strong>View All ‚Üí</strong></small>
                                            </a>
                                        </li>
                                    </ul>
                                </li>

                                <!-- Dashboard Link -->
                                <li class="nav-item me-3">
                                    <a class="nav-link @(currentController == "Dashboard" && currentArea == "Admin" ? "active fw-bold" : "") text-danger fw-bold"
                                       asp-area="Admin" asp-controller="Dashboard" asp-action="Index">
                                        <i class="bi bi-speedometer2 me-1"></i> Dashboard
                                    </a>
                                </li>
                            }

                            <!-- Profile -->
                            <li class="nav-item dropdown me-3">
                                <a class="nav-link dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown" role="button" aria-expanded="false">
                                    <i class="bi bi-person-circle me-1"></i> 
                                    <span class="d-none d-md-inline">@displayName</span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <h6 class="dropdown-header">
                                            <i class="bi bi-person me-1"></i> @displayName
                                        </h6>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item" asp-controller="Account" asp-action="Profile">
                                            <i class="bi bi-person me-2"></i> My Profile
                                        </a>
                                    </li>
                                   @*  <li>
                                        <a class="dropdown-item" asp-controller="Account" asp-action="Settings">
                                            <i class="bi bi-gear me-2"></i> Settings
                                        </a>
                                    </li> *@
                                </ul>
                            </li>

                            <!-- Logout -->
                            <li class="nav-item">
                                <form asp-controller="Account" asp-action="Logout" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-danger btn-sm">
                                        <i class="bi bi-box-arrow-right me-1"></i> Logout
                                    </button>
                                </form>
                            </li>
                        }
                        else
                        {
                            <!-- Guest -->
                            <li class="nav-item me-2">
                                <a class="btn btn-outline-primary" asp-controller="Account" asp-action="Login">Login</a>
                            </li>
                            <li class="nav-item">
                                <a class="btn btn-primary" asp-controller="Account" asp-action="Register">Register</a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
    </header>

 @*    <header>
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3">
            <div class="container-fluid">

                <!-- ŸÑŸàÿ¨Ÿà / ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàŸÇÿπ ŸäŸàÿØŸëŸä ÿπŸÑŸâ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
                <a class="navbar-brand fw-bold" asp-area="" asp-controller="Product" asp-action="Index">
                    StudentBazaar
                </a>

                <button class="navbar-toggler" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target=".navbar-collapse"
                        aria-controls="navbarSupportedContent"
                        aria-expanded="false"
                        aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">

                    <!-- LEFT LINKS -->
                    <ul class="navbar-nav flex-grow-1">
                        <li class="nav-item">
                            <a class="nav-link text-dark @(currentController == "Product" ? "active fw-semibold" : "")"
                               asp-controller="Product" asp-action="Index">
                                Shop
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark @(currentController == "Home" && currentAction == "Index" ? "active fw-semibold" : "")"
                               asp-controller="Home" asp-action="Index">
                                Home
                            </a>
                        </li>
                    </ul>

                    <!-- RIGHT SIDE -->
                    <ul class="navbar-nav align-items-center">

                        @if (isAuthenticated)
                        {
                            <!-- ÿßÿ≥ŸÖ ÿßŸÑŸäŸàÿ≤ÿ± ÿ£Ÿà ÿßÿ≥ŸÖ ÿßŸÑŸÑŸä ÿ®ŸÉŸÑŸÖŸá ŸÅŸä ÿßŸÑÿ¥ÿßÿ™ -->
                            <li class="nav-item me-3">
                                <span class="navbar-text">
                                    Hello, @displayName
                                    @if (isAdmin)
                                    {
                                        <span class="badge bg-danger ms-1">Admin</span>
                                    }
                                </span>
                            </li>

                            <!-- Cart -->
                            <li class="nav-item me-3">
                                <a class="nav-link position-relative @(currentController == "Cart" ? "active" : "")"
                                   asp-controller="Cart" asp-action="Index">
                                    üõí Cart
                                </a>
                            </li>

                            <!-- Messages -->
                            <li class="nav-item me-3">
                                <a class="nav-link @(currentController == "Chat" ? "active fw-semibold" : "")"
                                   asp-controller="Chat" asp-action="Open">
                                    Messages
                                </a>
                            </li>

                            <!-- Logout -->
                            <li class="nav-item">
                                <form asp-controller="Account" asp-action="Logout" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-danger">
                                        Logout
                                    </button>
                                </form>
                            </li>
                        }
                        else
                        {
                            <!-- Login / Register -->
                            <li class="nav-item me-2">
                                <a class="btn btn-outline-primary"
                                   asp-controller="Account"
                                   asp-action="Login">
                                    Login
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="btn btn-primary"
                                   asp-controller="Account"
                                   asp-action="Register">
                                    Register
                                </a>
                            </li>
                        }

                    </ul>

                </div>
            </div>
        </nav>
    </header> *@

    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <footer class="border-top footer text-muted">
        <div class="container">
            &copy; 2025 - StudentBazaar -
            <a asp-controller="Home" asp-action="Privacy">Privacy</a>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    
    @if (isAuthenticated)
    {
        <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    }

    @if (isAdmin)
    {
        <script>
            // Admin Notifications System
            (function() {
                let adminHubConnection = null;
                const notificationsBadge = document.getElementById('notificationsBadge');
                const notificationsContainer = document.getElementById('notificationsDropdownContainer');
                const notificationsList = document.getElementById('dashboardNotificationsList');
                
                if (!notificationsBadge || !notificationsContainer || !notificationsList) return;
                
                // Function to update notifications badge
                window.updateNotificationsBadge = async function() {
                    try {
                        const response = await fetch('/Admin/Notifications/GetDashboardNotificationsCount');
                        if (response.ok) {
                            const data = await response.json();
                            const count = data.count || 0;
                            
                            if (count > 0) {
                                notificationsBadge.textContent = count > 99 ? '99+' : count.toString();
                                notificationsBadge.style.display = 'inline-block';
                            } else {
                                notificationsBadge.style.display = 'none';
                            }
                        }
                    } catch (error) {
                        console.error('Error updating notifications badge:', error);
                    }
                };
                
                // Function to load notifications in dropdown
                async function loadNotifications() {
                    const loadingEl = document.getElementById('notificationsLoading');
                    const emptyEl = document.getElementById('notificationsEmpty');
                    
                    try {
                        const response = await fetch('/Admin/Notifications/GetNotifications');
                        if (response.ok) {
                            const notifications = await response.json();
                            
                            if (loadingEl) loadingEl.style.display = 'none';
                            if (emptyEl) emptyEl.style.display = 'none';
                            
                            // Clear existing notifications
                            const itemsToRemove = notificationsList.querySelectorAll('li:not(.dropdown-header):not(.dropdown-divider):not(#notificationsLoading):not(#notificationsEmpty)');
                            itemsToRemove.forEach(item => {
                                const isButton = item.id === 'markAllAsReadBtn' || item.querySelector('#markAllAsReadBtn');
                                const isViewAll = item.querySelector('a[href*="/Admin/Dashboard"]');
                                if (!isButton && !isViewAll) {
                                    item.remove();
                                }
                            });
                            
                            if (notifications && notifications.length > 0) {
                                notifications.forEach(function(notif) {
                                    const iconClass = notif.type?.toLowerCase() === 'success' ? '‚úÖ' : 
                                                     notif.type?.toLowerCase() === 'warning' ? '‚ö†Ô∏è' : 
                                                     notif.type?.toLowerCase() === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
                                    
                                    const itemClass = notif.isRead ? '' : 'fw-bold bg-light';
                                    const date = new Date(notif.createdAt);
                                    const timeAgo = getTimeAgo(date);
                                    
                                    const li = document.createElement('li');
                                    li.className = itemClass;
                                    
                                    let html = `<a class="dropdown-item ${notif.linkUrl ? '' : 'pe-none'}" ${notif.linkUrl ? `href="${notif.linkUrl}"` : ''} data-notification-id="${notif.id}">`;
                                    html += `<div class="d-flex align-items-center">`;
                                    html += `<span class="me-2">${iconClass}</span>`;
                                    html += `<div class="flex-grow-1">`;
                                    html += `<strong class="small">${escapeHtml(notif.title)}</strong>`;
                                    html += `<small class="text-muted d-block mt-1">${escapeHtml(notif.message)}</small>`;
                                    html += `<small class="text-muted d-block mt-1">${timeAgo}</small>`;
                                    html += `</div></div></a>`;
                                    
                                    li.innerHTML = html;
                                    
                                    const dividers = notificationsList.querySelectorAll('.dropdown-divider');
                                    if (dividers.length > 0) {
                                        const lastDivider = dividers[dividers.length - 1];
                                        notificationsList.insertBefore(li, lastDivider);
                                    } else {
                                        notificationsList.appendChild(li);
                                    }
                                    
                                    if (notif.linkUrl) {
                                        li.querySelector('a').addEventListener('click', function() {
                                            if (!notif.isRead) {
                                                markAsRead(notif.id);
                                            }
                                        });
                                    }
                                });
                            } else {
                                if (emptyEl) emptyEl.style.display = 'block';
                            }
                        }
                    } catch (error) {
                        console.error('Error loading notifications:', error);
                        if (loadingEl) loadingEl.innerHTML = '<small class="text-danger">Error loading notifications</small>';
                    }
                }
                
                async function markAsRead(notificationId) {
                    try {
                        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                        const response = await fetch('/Admin/Notifications/MarkAsRead', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': token
                            },
                            body: JSON.stringify({ id: notificationId })
                        });
                        
                        if (response.ok) {
                            updateNotificationsBadge();
                        }
                    } catch (error) {
                        console.error('Error marking notification as read:', error);
                    }
                }
                
                const markAllAsReadBtn = document.getElementById('markAllAsReadBtn');
                if (markAllAsReadBtn) {
                    markAllAsReadBtn.addEventListener('click', async function(e) {
                        e.preventDefault();
                        try {
                            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                            const response = await fetch('/Admin/Notifications/MarkAllAsRead', {
                                method: 'POST',
                                headers: {
                                    'RequestVerificationToken': token
                                }
                            });
                            
                            if (response.ok) {
                                updateNotificationsBadge();
                                loadNotifications();
                            }
                        } catch (error) {
                            console.error('Error marking all as read:', error);
                        }
                    });
                }
                
                function getTimeAgo(date) {
                    const now = new Date();
                    const diff = now - date;
                    const seconds = Math.floor(diff / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const hours = Math.floor(minutes / 60);
                    const days = Math.floor(hours / 24);
                    
                    if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
                    if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
                    if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                    return 'Just now';
                }
                
                function escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
                
                function setupAdminHub() {
                    if (typeof signalR === 'undefined') {
                        setInterval(updateNotificationsBadge, 5000);
                        return;
                    }
                    
                    try {
                        adminHubConnection = new signalR.HubConnectionBuilder()
                            .withUrl("/adminhub")
                            .withAutomaticReconnect()
                            .build();
                        
                        adminHubConnection.on("AdminNotification", function(data) {
                            updateNotificationsBadge();
                            const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('notificationsDropdown'));
                            if (dropdown && dropdown._isShown()) {
                                loadNotifications();
                            }
                        });
                        
                        adminHubConnection.start()
                            .then(function() {
                                adminHubConnection.invoke("JoinAdminGroup");
                                updateNotificationsBadge();
                            })
                            .catch(function(error) {
                                console.warn('Admin Hub connection failed, using polling:', error);
                                setInterval(updateNotificationsBadge, 5000);
                            });
                        
                        adminHubConnection.onreconnected(function() {
                            adminHubConnection.invoke("JoinAdminGroup");
                            updateNotificationsBadge();
                        });
                    } catch (error) {
                        console.error('Error setting up Admin Hub:', error);
                        setInterval(updateNotificationsBadge, 5000);
                    }
                }
                
                const notificationsDropdown = document.getElementById('notificationsDropdown');
                if (notificationsDropdown) {
                    notificationsDropdown.addEventListener('shown.bs.dropdown', function() {
                        loadNotifications();
                    });
                }
                
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        setTimeout(updateNotificationsBadge, 100);
                        setupAdminHub();
                        setInterval(updateNotificationsBadge, 10000);
                    });
                } else {
                    setTimeout(updateNotificationsBadge, 100);
                    setupAdminHub();
                    setInterval(updateNotificationsBadge, 10000);
                }
            })();
        </script>
    }

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
